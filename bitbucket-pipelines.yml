options:
  docker: true
image: google/cloud-sdk
clone:
  depth: 1

pipelines:
  default:
    - step:
        script:

          #-----------------------------------
          # Build tag and push the container:
          #-----------------------------------

          - export IMAGE_NAME='quay.io/softonic/tva-voting'
          - docker build -t ${IMAGE_NAME}:${BITBUCKET_COMMIT::6} .
          - docker tag ${IMAGE_NAME}:${BITBUCKET_COMMIT::6} ${IMAGE_NAME}:latest
          - docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} quay.io
          - docker push ${IMAGE_NAME}

          #---------------------------------
          # Setup google cloud credentials:
          #---------------------------------

          - echo ${GCLOUD_SVCACCOUNT_KEY} | base64 -di > key.json
          - gcloud auth activate-service-account --key-file key.json
          - gcloud config set project ${GCLOUD_PROJECT}
          - gcloud container clusters get-credentials kube-1 ${K8S_CLUSTER_NAME} --zone europe-west1-b --project ${GCLOUD_PROJECT}

          #---------------
          # Install Helm:
          #---------------

          - export HELM_GET='https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get'
          - wget -q -O - ${HELM_GET} | sed 's/\<sudo\>//g' | bash
          - helm init --upgrade
